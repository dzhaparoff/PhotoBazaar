!function(){"use strict";function infinitePaginationPhotosList($location,$http,$compile,$timeout,$cacheFactory){return{restrict:"A",scope:{total:"@",perPage:"@",id:"@",lastPhotoOfTheDay:"@"},link:function($scope,$element){function scrollListner(){var scrollDelta=document.body.scrollHeight-$(window).scrollTop()-document.body.clientHeight;300>scrollDelta&&show_page("next")}function show_page(mode){var path=new Url($location.absUrl()),pages=[];$($li).each(function(){pages.push($(this).attr("data-page"))});var first_page_number=_.min(pages),last_page_number=_.max(pages),pages_count=parseInt($scope.total/$scope.perPage)+1,navigate_Photos=!1;path.query.mode="partial","next"==mode&&pages_count>last_page_number?(page_number=parseInt(last_page_number)+1,navigate_Photos="append"):"prev"==mode&&first_page_number>1&&(page_number=parseInt(first_page_number)-1,navigate_Photos="prepend"),path.query.page=page_number,navigate_Photos&&($scope.$emit("loading_start"),$http.get(path.toString()).success(function(data){var another_photo_of_day=angular.element(data).filter(".photo_of_the_day");data=angular.element(data).filter("li"),another_photo_of_day.attr("data-number")==last_photo_of_the_day?another_photo_of_day=null:last_photo_of_the_day=another_photo_of_day.attr("data-number");var template=$(data);reinit_chache_for_infinite_pagination(data);var imgLoad=imagesLoaded(template),items_count=template.find("img").length,cur_item=0;imgLoad.on("progress",function(){var progress=cur_item/items_count*100;cur_item+=1,$scope.$emit("loading_progress",progress)}),imgLoad.on("always",function(){var prepend_dummies="";if("append"==navigate_Photos)if(null!=another_photo_of_day){var dummy_height=getDummyHeigh(last_photo_of_the_day,height);prepend_dummies=angular.element('<li class="dummy full" id="lbph_index_'+last_photo_of_the_day+'"></li>'),$element.append(prepend_dummies).append(template),$("#lbph_index_"+last_photo_of_the_day).css({height:dummy_height}),anim_on_scroll._reinit(prepend_dummies.add(template),0,checkAnimationLock())}else $element.append(template),anim_on_scroll._reinit(template,0,checkAnimationLock());if("prepend"==navigate_Photos&&$element.prepend(template),$li=$element.children("li"),"append"==navigate_Photos){var another_photo_of_day_template=$(another_photo_of_day);$compile(another_photo_of_day_template)($scope),$(".pusher").append(another_photo_of_day_template)}$compile(template)($scope),$(document).on("scroll",function(){scrollListner()}),imgLoad.off("progress"),imgLoad.off("always"),$scope.$emit("loading_complete")})}),$(document).off("scroll"))}function checkAnimationLock(){var posY=window.scrollY;return"undefined"!=typeof $cacheFactory["scrollPositions_"+$location.absUrl()]?posY>$cacheFactory["scrollPositions_"+$location.absUrl()]?($cacheFactory["scrollPositions_"+$location.absUrl()]=void 0,!1):!0:!1}function reinit_chache_for_infinite_pagination(new_elements){if("undefined"!=typeof $cacheFactory[$location.absUrl()]){var $cached=$($cacheFactory[$location.absUrl()]);$cached.find("#Photos").append(new_elements),$cacheFactory[$location.absUrl()]=$("<div></div>").append($cached).html()}}function init_AnimOnScroll(element,viewportFactor){dontWaitImages=$cacheFactory["scrollPositions_"+$location.absUrl()]>0?!0:!1,anim_on_scroll=new AnimOnScroll(document.getElementById(element),{minDuration:.4,maxDuration:.7,viewportFactor:viewportFactor,dontWaitImages:dontWaitImages,dontAnimate:checkAnimationLock()})}function getDummyHeigh(number,height){var last_elements,delta,el_number,pos_array=[];for(el_number=parseInt(number)+1;0==$('[data-bp-number="'+el_number+'"]').length;)++el_number;return $('[data-bp-number="'+el_number+'"]').each(function(index){pos_array[index]=$(this).offset().top+$(this).height()}),last_elements=_.takeRight(_.sortBy(pos_array),3),delta=_.max(last_elements)-_.min(last_elements),.6*height-delta}var scrollListner,show_page,init_AnimOnScroll,checkAnimationLock,getDummyHeigh,anim_on_scroll,reinit_chache_for_infinite_pagination,$li=$element.children("li"),page_number=1,last_photo_of_the_day=$scope.lastPhotoOfTheDay,height=screen.height,dontWaitImages=!1;$(document).on("scroll",function(){scrollListner()}),init_AnimOnScroll($scope.id,.2),$scope.$watch("page_number",function(n,o){n!=o&&n>0&&($location.search("page",n),$scope.$emit("disableLocationListener",!0),$timeout(function(){$scope.$emit("disableLocationListener",!1)}))}),$element.bind("$destroy",function(){$(document).off("scroll"),$li=null,anim_on_scroll._destroy(),anim_on_scroll=null,$scope.$destroy()})}}}angular.module("phb").directive("infinitePaginationPhotosList",infinitePaginationPhotosList),infinitePaginationPhotosList.$inject=["$location","$http","$compile","$timeout","$cacheFactory","ngProgress"]}();